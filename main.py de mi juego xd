from kivy.app import App
from kivy.uix.screenmanager import ScreenManager, Screen, FadeTransition
from kivy.uix.button import Button
from kivy.uix.image import Image
from kivy.uix.label import Label
from kivy.uix.gridlayout import GridLayout
from kivy.uix.floatlayout import FloatLayout
from kivy.uix.boxlayout import BoxLayout
from kivy.clock import Clock
from kivy.animation import Animation
from kivy.core.audio import SoundLoader
from random import choice

# Pateadores y porteros
pateadores = ["roberto_carlos", "ronaldinho", "yuri_alberto", "henry_martin", "uriel_antuna"]
porteros = ["cassio", "claudio_taffarel", "memo_ochoa", "rossi", "weverton"]

# Selección inicial
seleccion = {
    "pateador": pateadores[0],
    "portero": porteros[0]
}

# Variable global para música
musica_actual = None

def reproducir_musica(nombre_archivo):
    global musica_actual
    if musica_actual:
        musica_actual.stop()
    musica_actual = SoundLoader.load("assets/" + nombre_archivo + ".wav")
    if musica_actual:
        musica_actual.loop = True
        musica_actual.play()

# -------- Pantallas ---------

class MenuScreen(Screen):
    def on_enter(self):
        reproducir_musica("cancion_fondo_menu")

    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        layout = BoxLayout(orientation='vertical', padding=10, spacing=10)

        layout.add_widget(Image(source="assets/imagen_menu.png", allow_stretch=True, keep_ratio=False))

        botones = BoxLayout(orientation='vertical', spacing=10, size_hint=(1, 0.5))
        botones.add_widget(Button(text="Modo Penales", on_release=lambda x: setattr(self.manager, 'current', 'penales')))
        botones.add_widget(Button(text="Modo KickFall", on_release=lambda x: setattr(self.manager, 'current', 'kickfall')))
        botones.add_widget(Button(text="Escoger Personajes", on_release=lambda x: setattr(self.manager, 'current', 'selector')))
        botones.add_widget(Button(text="Créditos", on_release=lambda x: setattr(self.manager, 'current', 'creditos')))

        layout.add_widget(botones)
        self.add_widget(layout)

class SelectorScreen(Screen):
    def on_enter(self):
        reproducir_musica("cancion_fondo_selector")

    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        layout = BoxLayout(orientation='vertical', spacing=10, padding=10)

        layout.add_widget(Label(text="Selecciona Pateador", font_size=24))
        for p in pateadores:
            layout.add_widget(Button(text=p.replace("_", " ").title(), on_release=lambda x, p=p: self.seleccionar("pateador", p)))

        layout.add_widget(Label(text="Selecciona Portero", font_size=24))
        for p in porteros:
            layout.add_widget(Button(text=p.replace("_", " ").title(), on_release=lambda x, p=p: self.seleccionar("portero", p)))

        layout.add_widget(Button(text="Volver al Menú", on_release=lambda x: setattr(self.manager, 'current', 'menu')))
        self.add_widget(layout)

    def seleccionar(self, tipo, nombre):
        seleccion[tipo] = nombre

class PenalesScreen(Screen):
    def on_enter(self):
        reproducir_musica("cancion_fondo_penales")
        self.actualizar_imagenes()

    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.layout = FloatLayout()
        self.add_widget(self.layout)

        btn_volver = Button(text="Volver al Menú", size_hint=(1, 0.08), pos_hint={"top": 1})
        btn_volver.bind(on_release=lambda x: setattr(self.manager, 'current', 'menu'))
        self.layout.add_widget(btn_volver)

        fondo = Image(source="assets/fondo_penales.png", allow_stretch=True, keep_ratio=False)
        self.layout.add_widget(fondo)

        self.porteria = Image(size_hint=(0.8, 0.3), pos_hint={"center_x": 0.5, "y": 0.55})
        self.layout.add_widget(self.porteria)

        self.portero_img = Image(size_hint=(0.3, 0.35), pos_hint={"center_x": 0.5, "y": 0.58})
        self.layout.add_widget(self.portero_img)

        self.pateador_img = Image(size_hint=(0.25, 0.3), pos_hint={"center_x": 0.5, "y": 0.35})
        self.layout.add_widget(self.pateador_img)

        self.balon_img = Image(source="assets/balon.png", size_hint=(0.08, 0.08), pos_hint={"center_x": 0.5, "y": 0.25})
        self.layout.add_widget(self.balon_img)

        self.marcador = Label(text="0 - 0", font_size=32, size_hint=(1, 0.08), pos_hint={"y": 0.33})
        self.layout.add_widget(self.marcador)

        self.puntos_pateador = 0
        self.puntos_portero = 0

        direcciones = [
            ("flecha_izq_arriba", "sup_izq"), ("flecha_arriba", "sup_cent"), ("flecha_der_arriba", "sup_der"),
            ("flecha_izquierda", "med_izq"), ("centro", "med_cent"), ("flecha_derecha", "med_der"),
            ("flecha_izq_abajo", "inf_izq"), ("flecha_abajo", "inf_cent"), ("flecha_der_abajo", "inf_der")
        ]

        grid = GridLayout(cols=3, spacing=5, size_hint=(1, 0.25), pos_hint={"y": 0})
        for img, codigo in direcciones:
            btn = Button(background_normal=f"assets/{img}.png")
            btn.bind(on_release=lambda x, c=codigo: self.disparar(c))
            grid.add_widget(btn)
        self.layout.add_widget(grid)

    def actualizar_imagenes(self):
        pateador = seleccion["pateador"]
        portero = seleccion["portero"]
        self.pateador_img.source = f"assets/{pateador}_pen1.png"
        self.portero_img.source = f"assets/{portero}_med_cent_ataja.png"
        self.porteria.source = "assets/porteria.png"

    def disparar(self, direccion):
        pateador = seleccion["pateador"]
        portero = seleccion["portero"]
        self.pateador_img.source = f"assets/{pateador}_pen2.png"
        ataja = choice([True, False])
        if ataja:
            self.portero_img.source = f"assets/{portero}_{direccion}_ataja.png"
            self.puntos_portero += 1
        else:
            self.portero_img.source = f"assets/{portero}_{direccion}_falla.png"
            self.puntos_pateador += 1

        anim = Animation(y=0.6, duration=0.5) + Animation(opacity=0, duration=0.2)
        anim.bind(on_complete=lambda *a: self.reset_balon())
        anim.start(self.balon_img)

        self.marcador.text = f"{self.puntos_pateador} - {self.puntos_portero}"
        Clock.schedule_once(lambda dt: self.actualizar_imagenes(), 1)

    def reset_balon(self):
        self.balon_img.opacity = 1
        self.balon_img.pos_hint = {"center_x": 0.5, "y": 0.25}

class KickFallScreen(Screen):
    def on_enter(self):
        reproducir_musica("cancion_fondo_kickfall")

    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.layout = FloatLayout()
        self.add_widget(self.layout)

        self.fondo = Image(source="assets/fondo_kickfall.png", allow_stretch=True, keep_ratio=False)
        self.layout.add_widget(self.fondo)

        self.player_index = 1
        self.player = Image(
            source=f"assets/{seleccion['pateador']}_kickfall1.png",
            size=(600, 800),
            size_hint=(None, None),
            pos_hint={"center_x": 0.5, "y": 0.05}
        )
        self.layout.add_widget(self.player)

        self.balon = Image(
            source="assets/balon_kickfall.png",
            size=(150, 150),
            size_hint=(None, None),
            pos_hint={"center_x": 0.55, "y": 0.07}
        )
        self.layout.add_widget(self.balon)

        self.score = 0
        self.label = Label(
            text="0",
            font_size=40,
            color=(1,1,1,1),
            size_hint=(0.2, 0.1),
            pos_hint={"center_x":0.5, "top":1}
        )
        self.layout.add_widget(self.label)

        self.anim = None
        self.bind(on_touch_down=self.tocar_pantalla)

        btn_volver = Button(text="Volver al Menú", size_hint=(0.2, 0.1), pos_hint={"x":0, "top":1})
        btn_volver.bind(on_release=lambda x: setattr(self.manager, 'current', 'menu'))
        self.layout.add_widget(btn_volver)

    def tocar_pantalla(self, *args):
        if self.anim:
            self.anim.stop(self.balon)

        self.score += 1
        self.label.text = str(self.score)

        self.player_index = 2 if self.player_index == 1 else 1
        self.player.source = f"assets/{seleccion['pateador']}_kickfall{self.player_index}.png"

        self.anim = (
            Animation(pos_hint={"center_x":0.55, "y":0.5}, duration=0.3, t="out_cubic") +
            Animation(pos_hint={"center_x":0.55, "y":0.07}, duration=0.5, t="in_cubic")
        )
        self.anim.start(self.balon)

class CreditosScreen(Screen):
    def on_enter(self):
        reproducir_musica("cancion_fondo_creditos")

    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        layout = BoxLayout(orientation='vertical', padding=20, spacing=10)
        layout.add_widget(Label(text="Créditos:\nQUIEN CARAJOS VE LOS CREDITOS???", font_size=50))
        layout.add_widget(Button(text="Volver al Menú", on_release=lambda x: setattr(self.manager, 'current', 'menu')))
        self.add_widget(layout)

class JuegoApp(App):
    def build(self):
        sm = ScreenManager(transition=FadeTransition())
        sm.add_widget(MenuScreen(name="menu"))
        sm.add_widget(PenalesScreen(name="penales"))
        sm.add_widget(KickFallScreen(name="kickfall"))
        sm.add_widget(SelectorScreen(name="selector"))
        sm.add_widget(CreditosScreen(name="creditos"))
        return sm

if __name__ == "__main__":
    JuegoApp().run()
